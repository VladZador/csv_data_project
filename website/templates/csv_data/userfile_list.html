{% extends 'base.html' %}

{% block title %}CSV data{% endblock %}

{% block external %}
<style>
    input.invalid {
        background-color: #ffdddd;
    }
</style>
{% endblock %}

{% block content %}

<h3>Choose data schema</h3>
{% if schemas %}
{% for schema in schemas.iterator %}

    <p><input type="radio" id="{{ schema.name }}"name="schema" value="{{ schema.name }}">
    <label for="{{ schema.name }}">{{ schema.name }}</label></p>

{% endfor %}
<h3>Enter the number of records to generate</h3>
<input type="text" id="recordsNumber" name="recordsNumber"
oninput="this.className = ''">

<button type="button" id="generateBtn" data-url="{% url 'generate_data' %}" onclick="generateData()">Generate data</button>
</form>
{% else %}
<p> There's nothing in here </p>
{% endif %}

<script>

function validateRadio() {
    const radios = document.querySelectorAll('input[type="radio"]');
    const checkedOne = Array.prototype.slice.call(radios).some(x => x.checked);
    return checkedOne;
}

function invalidInputReceived(input) {
    input.className = "invalid";
    input.value = "";
    input.placeholder = "Input must be a positive integer";
}

function validateNumber() {
    const input = document.getElementById("recordsNumber");
    if (isNaN(input.value)){
        invalidInputReceived(input);
        return false;
    }

    const recordsNumber = parseFloat(input.value);
    if (!(Number.isInteger(recordsNumber)) || recordsNumber <= 0) {
        invalidInputReceived(input);
        return false;
    }
    return recordsNumber
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

function sendRequest(name, number) {
    
    const url = document.getElementById("generateBtn").dataset.url;

    const data = {name: name, number: number};

    fetch(url, {
        method: "POST",
        credentials: "same-origin",
        headers: {
            "Accept": "application/json",
            "X-Requested-With": "XMLHttpRequest",
            "X-CSRFToken": csrftoken,
        },
        body: JSON.stringify({"post_data":data}),
        redirect: "follow"
    })
        .then(response => response.json())
        .then(data => {
            console.log(data);
        })
}

function generateData() {
    if (!validateRadio()) {
        alert("Choose data schema");
        return false;
    }
    const recordsNumber = validateNumber();
    if (!recordsNumber) {
        return false;
    }

    const chosenSchemaName = document.querySelector('input[name="schema"]:checked').value;
    
    console.log(chosenSchemaName, recordsNumber);
    sendRequest(chosenSchemaName, recordsNumber);
    console.log("done!");
}
    
</script>

{% endblock %}